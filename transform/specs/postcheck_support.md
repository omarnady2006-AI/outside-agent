# Postcheck Support

## Overview

The Transform Engine must prepare data for **post‑check** after the privacy‑fix step has been applied. Post‑check validates that the transformed output complies with downstream privacy and security constraints before it is handed off to any consumer or further processing stage.

---

## 1. Execution Order

- **Post‑check runs *after* the privacy‑fix step**. The privacy‑fix step removes or masks direct identifiers (e.g., email, phone). Only once that step is complete should the post‑check validation be executed.

---

## 2. Prohibited Patterns

The output of the Transform Engine must **not contain email‑like or phone‑like patterns**. Typical regex patterns that are scanned for include:

- `\b[\w.%+-]+@[\w.-]+\.[A-Za-z]{2,}\b`  (email addresses)
- `\b\d{3}[-.\s]?\d{3}[-.\s]?\d{4}\b` (US phone numbers)
- International phone patterns such as `\+?\d{1,3}[\s-]?\(\d{1,4}\)[\s-]?\d{1,4}[\s-]?\d{1,4}`

If any of these patterns are detected, the post‑check should flag the record for review or reject it according to the configured policy.

---

## 3. Tokenized Fields

Fields that are **tokenized** by the Transform Engine are expected to be opaque strings and therefore **should not match the prohibited patterns**. Typical tokenized fields include:

- `user_id_token`
- `session_token`
- `record_hash`
- Any column listed in the **Policy Pack** under `tokenized_fields`

Because these values are generated by a secure tokenization service, they are exempt from pattern‑matching checks. The post‑check logic must skip these fields when scanning for email/phone patterns.

---

## 4. Gating Metadata Recorded by the Transform Engine

To aid downstream gating and audit, the Transform Engine should record the following optional metadata for each batch processed:

- **`sample_count`** – Number of records examined in the batch.
- **`pattern_scan_results`** – A summary object containing counts of detected prohibited patterns, e.g. `{ "email_matches": 3, "phone_matches": 0 }`.
- **`tokenized_field_count`** – Number of fields that were tokenized in the batch.
- **`postcheck_passed`** – Boolean flag indicating whether the batch satisfied all post‑check criteria.

These metrics can be logged or persisted to a monitoring store to enable automated gating decisions (e.g., abort pipeline if `email_matches` > 0).

---

## 5. Summary of Responsibilities

1. Ensure post‑check runs **after** privacy‑fix.
2. Scan output for email/phone patterns **excluding tokenized fields**.
3. Record optional gating metadata (sample counts, pattern scan results, tokenized field count, pass/fail flag).
4. Surface any violations to the downstream gating layer for appropriate handling.

---

*The above guidance aligns with the existing Policy Pack and does not introduce new policies.*
